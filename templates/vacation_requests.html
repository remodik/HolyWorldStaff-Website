{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>üèñÔ∏è –ó–∞—è–≤–∫–∏ –Ω–∞ –æ—Ç–ø—É—Å–∫</h2>

    <button class="btn btn-success mb-4" type="button" data-bs-toggle="modal" data-bs-target="#vacationModal">
        üìù –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ—Ç–ø—É—Å–∫
    </button>

    <div class="modal fade" id="vacationModal" tabindex="-1" aria-labelledby="vacationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="vacationModalLabel">üìù –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –æ—Ç–ø—É—Å–∫</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('submit_vacation_request') }}" id="vacationForm">
                        <div class="mb-4">
                            <label class="form-label fw-bold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ—Ç–ø—É—Å–∫–∞:</label>
                            <label>
                                <input type="date" class="form-control form-control-lg" name="start_date" required
                                       min="{{ now.strftime('%Y-%m-%d') }}">
                            </label>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Ç–ø—É—Å–∫–∞:</label>
                            <label>
                                <input type="date" class="form-control form-control-lg" name="end_date" required
                                       min="{{ now.strftime('%Y-%m-%d') }}">
                            </label>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–ø—É—Å–∫–∞:</label>
                            <label>
                                <textarea class="form-control" name="reason" rows="2" required
                                          placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–ø—É—Å–∫–∞"></textarea>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" form="vacationForm" class="btn btn-primary">
                        üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if current_user.access_level >= 4 and pending_requests %}
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5>‚è≥ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</h5>
        </div>
        <div class="card-body">
            {% for request in pending_requests %}
            <div class="card mb-3">
                <div class="card-body">
                    <h6>–ó–∞—è–≤–∫–∞ #{{ request.id }}</h6>
                    <p><strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</strong> {{ request.user.nickname or request.user.username }}</p>
                    <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> {{ request.start_date.strftime('%d.%m.%Y') }} - {{ request.end_date.strftime('%d.%m.%Y') }}</p>
                    <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ request.reason }}</p>
                    <p><strong>–ü–æ–¥–∞–Ω–∞:</strong> {{ request.created_at.strftime('%d.%m.%Y %H:%M') }}</p>

                    <form method="POST" action="{{ url_for('process_vacation_request', request_id=request.id) }}">
                        <div class="mb-2">
                            <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ (–µ—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç–µ):</label>
                            <label>
                                <textarea class="form-control" name="rejection_reason" rows="2"
                                          placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞..."></textarea>
                            </label>
                        </div>

                        <div class="btn-group">
                            <button style="margin-right: 5px; border-radius: 6px" type="submit" name="action" value="approve" class="btn btn-success">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                            <button style="border-radius: 6px" type="submit" name="action" value="reject" class="btn btn-danger">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header bg-info text-white">
            <h5>üìä –ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –∑–∞—è–≤–æ–∫</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="statusFilter" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
                <select class="form-select" id="statusFilter" onchange="filterRequests()">
                    <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                    <option value="approved">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
                    <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>

            <div id="requestsList">
                {% for request in user_requests %}
                <div class="card mb-2 request-item" data-status="{{ request.status }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>–ó–∞—è–≤–∫–∞ #{{ request.id }}</h6>
                                <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
                                    {% if request.status == 'pending' %}
                                        <span class="badge bg-warning">‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
                                    {% elif request.status == 'approved' %}
                                        <span class="badge bg-success">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</span>
                                    {% else %}
                                        <span class="badge bg-danger">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                                    {% endif %}
                                </p>
                                <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> {{ request.start_date.strftime('%d.%m.%Y') }} - {{ request.end_date.strftime('%d.%m.%Y') }}</p>
                                <p><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ request.reason }}</p>
                                <p><strong>–ü–æ–¥–∞–Ω–∞:</strong> {{ request.created_at.strftime('%d.%m.%Y %H:%M') }}</p>

                                {% if request.status == 'rejected' and request.rejection_reason %}
                                <p><strong>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:</strong>
                                    <span class="text-danger">{{ request.rejection_reason }}</span>
                                </p>
                                {% endif %}

                                {% if request.status == 'approved' and request.processed_at %}
                                <p><strong>–û–±—Ä–∞–±–æ—Ç–∞–Ω–∞:</strong> {{ request.processed_at.strftime('%d.%m.%Y %H:%M') }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –æ—Ç–ø—É—Å–∫.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    function filterRequests() {
        const status = document.getElementById('statusFilter').value;
        const requestItems = document.querySelectorAll('.request-item');

        requestItems.forEach(item => {
            if (status === 'all' || item.getAttribute('data-status') === status) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const vacationModal = document.getElementById('vacationModal');
        const startDateInput = vacationModal.querySelector('input[name="start_date"]');
        const endDateInput = vacationModal.querySelector('input[name="end_date"]');

        if (startDateInput && endDateInput) {
            startDateInput.addEventListener('change', function() {
                endDateInput.min = this.value;
                if (endDateInput.value && endDateInput.value < this.value) {
                    endDateInput.value = '';
                }
            });
        }

        vacationModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('vacationForm').reset();
        });
    });
</script>
{% endblock %}