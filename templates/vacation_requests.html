{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 fw-bold text-gradient-primary">üèñÔ∏è HolyStaff –û—Ç–ø—É—Å–∫–∏</h2>
        <button class="btn btn-success btn-lg rounded-pill shadow-sm" type="button" data-bs-toggle="modal" data-bs-target="#vacationModal">
            <i class="bi bi-calendar-plus me-2"></i>–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É
        </button>
    </div>

    <div class="modal fade" id="vacationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-gradient-success text-white">
                    <h5 class="modal-title fw-semibold">üìù –ó–∞—è–≤–∫–∞ –Ω–∞ –æ—Ç–ø—É—Å–∫</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('submit_vacation_request') }}" id="vacationForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ—Ç–ø—É—Å–∫–∞</label>
                            <label>
                                <input type="date" class="form-control form-control-lg" name="start_date" required
                                       min="{{ now.strftime('%Y-%m-%d') }}">
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ—Ç–ø—É—Å–∫–∞</label>
                            <label>
                                <input type="date" class="form-control form-control-lg" name="end_date" required
                                       min="{{ now.strftime('%Y-%m-%d') }}">
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–ø—É—Å–∫–∞</label>
                            <label><textarea class="form-control" name="reason" rows="4" required
                                             placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–ø—É—Å–∫–∞"></textarea>
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" form="vacationForm" class="btn btn-primary rounded-pill px-4">
                        üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if current_user.access_level >= 6 and pending_requests %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-warning bg-opacity-25 border-0 py-3">
            <h5 class="mb-0 fw-semibold">‚è≥ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</h5>
        </div>
        <div class="card-body">
            {% for request in pending_requests %}
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h6 class="text-primary fw-semibold">–ó–∞—è–≤–∫–∞ #{{ request.id }}</h6>
                        <span class="badge bg-warning rounded-pill">–û–∂–∏–¥–∞–µ—Ç</span>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</strong> {{ request.user.nickname or request.user.username }}</p>
                            <p class="mb-1"><strong>–ü–µ—Ä–∏–æ–¥:</strong> {{ request.start_date.strftime('%d.%m.%Y') }} - {{ request.end_date.strftime('%d.%m.%Y') }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>–ü–æ–¥–∞–Ω–∞:</strong> {{ request.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                        </div>
                    </div>

                    <p class="mb-3"><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ request.reason }}</p>

                    <form method="POST" action="{{ url_for('process_vacation_request', request_id=request.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:</label>
                            <label>
<textarea class="form-control" name="rejection_reason" rows="2"
          placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞..."></textarea>
                            </label>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" name="action" value="approve"
                                    class="btn btn-success rounded-pill flex-fill">
                                ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
                            </button>
                            <button type="submit" name="action" value="reject"
                                    class="btn btn-outline-danger rounded-pill flex-fill">
                                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-info bg-opacity-25 border-0 py-3">
            <h5 class="mb-0 fw-semibold">üìä –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-semibold">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
                <label for="statusFilter"></label><select class="form-select" id="statusFilter" onchange="filterRequests()">
                    <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                    <option value="approved">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
                    <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>

            <div id="requestsList">
                {% for request in user_requests %}
                <div class="card border-0 shadow-sm mb-3 request-item" data-status="{{ request.status }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="text-primary fw-semibold">–ó–∞—è–≤–∫–∞ #{{ request.id }}</h6>
                            {% if request.status == 'pending' %}
                                <span class="badge bg-warning rounded-pill">‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
                            {% elif request.status == 'approved' %}
                                <span class="badge bg-success rounded-pill">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</span>
                            {% else %}
                                <span class="badge bg-danger rounded-pill">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                            {% endif %}
                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>–ü–µ—Ä–∏–æ–¥:</strong> {{ request.start_date.strftime('%d.%m.%Y') }} - {{ request.end_date.strftime('%d.%m.%Y') }}</p>
                                <p class="mb-1"><strong>–ü–æ–¥–∞–Ω–∞:</strong> {{ request.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                            </div>
                            {% if request.status == 'approved' and request.processed_at %}
                            <div class="col-md-6">
                                <p class="mb-1"><strong>–û–±—Ä–∞–±–æ—Ç–∞–Ω–∞:</strong> {{ request.processed_at.strftime('%d.%m.%Y %H:%M') }}</p>
                            </div>
                            {% endif %}
                        </div>

                        <p class="mb-2"><strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> {{ request.reason }}</p>

                        {% if request.status == 'rejected' and request.rejection_reason %}
                        <div class="alert alert-danger mt-2 mb-0 py-2">
                            <strong>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:</strong> {{ request.rejection_reason }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-calendar-x display-4 text-muted"></i>
                    <p class="text-muted mt-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –æ—Ç–ø—É—Å–∫</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    .text-gradient-primary {
        background: linear-gradient(135deg, #007bff, #6610f2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .bg-gradient-success {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .card {
        border-radius: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1) !important;
    }

    .btn {
        transition: all 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-1px);
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: border-color 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
    }
</style>

<script>
    function filterRequests() {
        const status = document.getElementById('statusFilter').value;
        const requestItems = document.querySelectorAll('.request-item');

        requestItems.forEach(item => {
            if (status === 'all' || item.getAttribute('data-status') === status) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const vacationModal = document.getElementById('vacationModal');
        const startDateInput = vacationModal.querySelector('input[name="start_date"]');
        const endDateInput = vacationModal.querySelector('input[name="end_date"]');

        if (startDateInput && endDateInput) {
            startDateInput.addEventListener('change', function() {
                endDateInput.min = this.value;
                if (endDateInput.value && endDateInput.value < this.value) {
                    endDateInput.value = '';
                }
            });
        }

        vacationModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('vacationForm').reset();
        });

        filterRequests();
    });
</script>
{% endblock %}