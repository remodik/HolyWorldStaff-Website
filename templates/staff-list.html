{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div id="userAuthData"
         data-access-level="{{ current_user.access_level if current_user.is_authenticated else 0 }}"
         style="display: none;"></div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h2 fw-bold text-gradient-primary">üë• –ü–µ—Ä—Å–æ–Ω–∞–ª Discord HolyWorld</h2>
        <span class="badge bg-primary rounded-pill">{{ staff_members|selectattr('access_level', 'gt', 0)|list|length }} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-transparent border-0 py-3">
            <h5 class="mb-0 fw-semibold text-primary">
                <i class="bi bi-people-fill me-2"></i>–°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                            <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                            <th>–î–∏—Å–∫–æ—Ä–¥</th>
                            <th class="text-center">–ë–∞–ª–∞–Ω—Å</th>
                            <th class="text-center">–í—ã–≥–æ–≤–æ—Ä—ã</th>
                            <th class="text-center">–û—Ç–ø—É—Å–∫</th>
                            <th class="text-center">–ü—Ä–∏–Ω—è—Ç</th>
                            <th class="text-center">–í–ö–æ–Ω—Ç–∞–∫—Ç–µ</th>
                            {% if current_user.access_level >= 6 %}
                            <th class="text-center pe-4"></th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for member in staff_members %}
                            {% if member.access_level > 0 %}
                            <tr class="staff-row" data-member-id="{{ member.id }}">
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="position-relative me-3">
                                            {% if member.avatar %}
                                                <img src="{{ member.avatar }}" alt="–ê–≤–∞—Ç–∞—Ä" class="rounded-circle" width="48" height="48">
                                            {% else %}
                                                <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                                    <i class="bi bi-person-fill text-white"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <div class="fw-semibold">
                                                {% if member.vk_link %}
                                                    <a href="{{ member.vk_link }}" target="_blank" class="text-decoration-none text-dark">
                                                        {{ member.full_name|default(member.username, true) }}
                                                    </a>
                                                {% else %}
                                                    –ò–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">
                                                {{ member.nickname|default('–ù–∏–∫ –Ω–µ —É–∫–∞–∑–∞–Ω', true) }}
                                            </small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if member.access_level == 9 %}
                                        <span class="badge bg-danger rounded-pill">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                                    {% elif member.access_level == 8 %}
                                        <span class="badge bg-purple rounded-pill">–ö—É—Ä–∞—Ç–æ—Ä</span>
                                    {% elif member.access_level == 7 %}
                                        <span class="badge bg-pink rounded-pill">–ó–∞–º.–ö—É—Ä–∞—Ç–æ—Ä–∞</span>
                                    {% elif member.access_level == 6 %}
                                        <span class="badge bg-success rounded-pill">–ì–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                    {% elif member.access_level == 5 %}
                                        <span class="badge bg-warning rounded-pill text-dark">–°—Ç.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                    {% elif member.access_level == 4 %}
                                        <span class="badge rounded-pill text-dark" style="background-color: #ffc107">–°–ª–µ–¥—è—â–∏–π –∑–∞ —Ö–µ–ª–ø–µ—Ä–∞–º–∏</span>
                                    {% elif member.access_level == 3 %}
                                        <span class="badge bg-info rounded-pill">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                    {% elif member.access_level == 2 %}
                                        <span class="badge bg-cyan rounded-pill">–ú–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                    {% elif member.access_level == 1 %}
                                        <span class="badge bg-orange rounded-pill">–•–µ–ª–ø–µ—Ä</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="bi me-2 text-primary"></i>
                                        <span>{{ member.username|default('–ù–µ —É–∫–∞–∑–∞–Ω', true) }}</span>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <span class="fw-bold text-success">{{ member.salary|default('0', true) }}</span>
                                </td>
                                <td class="text-center">
                                    {% set warnings = member.warnings.split('/') if member.warnings else ['0', '0'] %}
                                    <div class="d-flex flex-column gap-1">
                                        <div class="d-flex align-items-center justify-content-center gap-1">
                                            <span class="badge bg-{{ 'danger' if warnings[0]|int > 0 else 'secondary' }} rounded-pill">
                                                –í—ã–≥–æ–≤–æ—Ä {{ warnings[0] }}/2
                                            </span>
                                            {% if current_user.access_level >= 6 and current_user.access_level > member.access_level %}
                                                <div class="btn-group btn-group-sm">
                                                    {% if warnings[0]|int > 0 %}
                                                    <button class="btn btn-outline-danger px-2" onclick="updateWarnings('{{ member.id }}', 'warn', -1)">
                                                        <i class="bi bi-dash"></i>
                                                    </button>
                                                    {% endif %}
                                                    <button class="btn btn-outline-success px-2" onclick="updateWarnings('{{ member.id }}', 'warn', 1)">
                                                        <i class="bi bi-plus"></i>
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="d-flex align-items-center justify-content-center gap-1">
                                            <span class="badge bg-{{ 'warning' if warnings[1]|int > 0 else 'secondary' }} rounded-pill text-dark">
                                                –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ {{ warnings[1] }}/3
                                            </span>
                                            {% if current_user.access_level >= 6 and current_user.access_level > member.access_level %}
                                                <div class="btn-group btn-group-sm">
                                                    {% if warnings[1]|int > 0 %}
                                                    <button class="btn btn-outline-danger px-2" onclick="updateWarnings('{{ member.id }}', 'pred', -1)">
                                                        <i class="bi bi-dash"></i>
                                                    </button>
                                                    {% endif %}
                                                    <button class="btn btn-outline-success px-2" onclick="updateWarnings('{{ member.id }}', 'pred', 1)">
                                                        <i class="bi bi-plus"></i>
                                                    </button>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {% if member.vacation_date %}
                                        <span class="badge bg-info rounded-pill">
                                            üèñÔ∏è {{ member.vacation_date.strftime('%d.%m.%Y') }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if member.join_date %}
                                        <span class="badge bg-light text-dark rounded-pill">
                                            üìÖ {{ member.join_date.strftime('%d.%m.%Y') }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if member.vk_link %}
                                        <a href="{{ member.vk_link }}" target="_blank" class="btn btn-sm btn-outline-primary rounded-pill">
                                            <i class="bi bi-link-45deg"></i> VK
                                        </a>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                {% if current_user.access_level >= 6 %}
                                <td class="text-center pe-4">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary rounded-pill me-1"
                                                onclick="loadMemberData('{{ member.id }}')"
                                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        {% if current_user.access_level > member.access_level %}
                                        <button class="btn btn-sm btn-outline-danger rounded-pill"
                                                onclick="quickDismiss('{{ member.id }}')"
                                                title="–°–Ω—è—Ç—å —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏">
                                            <i class="bi bi-person-x"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                                {% endif %}
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title fw-semibold">
                        <i class="bi bi-person-gear me-2"></i>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editForm" method="POST" action="{{ url_for('update_staff_member') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="member_id" id="memberId">
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">–ò–º—è –§–∞–º–∏–ª–∏—è</label>
                                <label for="fullName"></label><input type="text" class="form-control form-control-lg" name="full_name" id="fullName" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">–ù–∏–∫–Ω–µ–π–º</label>
                                <label for="nickname"></label><input type="text" class="form-control form-control-lg" name="nickname" id="nickname" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">–ë–∞–ª–∞–Ω—Å</label>
                                <label for="salary"></label><input type="text" class="form-control form-control-lg" name="salary" id="salary" placeholder="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">–í—ã–≥–æ–≤–æ—Ä—ã/–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è</label>
                                <label for="warnings"></label><input type="text" class="form-control form-control-lg" name="warnings" id="warnings" placeholder="0/0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">–î–∞—Ç–∞ –æ—Ç–ø—É—Å–∫–∞</label>
                                <label for="vacationDate"></label><input type="date" class="form-control form-control-lg" name="vacation_date" id="vacationDate">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold">–î–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∏—è</label>
                                <label for="joinDate"></label><input type="date" class="form-control form-control-lg" name="join_date" id="joinDate">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold">–°—Å—ã–ª–∫–∞ VK</label>
                                <label for="vkLink"></label><input type="url" class="form-control form-control-lg" name="vk_link" id="vkLink" placeholder="https://vk.com/username">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="button" class="btn btn-outline-danger rounded-pill" id="dismissButton" style="display: none;" onclick="showDismissModal()">
                            <i class="bi bi-person-x me-1"></i>–°–Ω—è—Ç—å
                        </button>
                        <button type="submit" class="btn btn-primary rounded-pill px-4">
                            <i class="bi bi-check-lg me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="dismissModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-semibold">
                        <i class="bi bi-person-x-fill me-2"></i>–°–Ω—è—Ç—å —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="dismissForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="member_id" id="dismissMemberId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">–ü—Ä–∏—á–∏–Ω–∞ —Å–Ω—è—Ç–∏—è</label>
                            <label for="dismissalReason"></label><textarea class="form-control" name="dismissal_reason" id="dismissalReason" rows="3" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É —Å–Ω—è—Ç–∏—è..."></textarea>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="remove_roles" id="removeRoles" checked>
                            <label class="form-check-label" for="removeRoles">
                                –°–Ω—è—Ç—å Discord —Ä–æ–ª–∏
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer border-0">
                        <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-danger rounded-pill px-4">
                            <i class="bi bi-trash me-1"></i>–°–Ω—è—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if current_user.access_level >= 8 %}
    <div class="card border-0 shadow-sm mt-5">
        <div class="card-header bg-transparent border-0 py-3">
            <h5 class="mb-0 fw-semibold text-primary">
                <i class="bi bi-gear-fill me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—è–º–∏
            </h5>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('update_staff_roles') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label fw-semibold">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                        <label for="roleSelect"></label><select class="form-select form-select-lg" name="role_level" id="roleSelect">
                            <option value="6">–ö—É—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞</option>
                            <option value="5">–ó–∞–º.–ö—É—Ä–∞—Ç–æ—Ä–∞ –¥–∏—Å–∫–æ—Ä–¥–∞</option>
                            <option value="4">–ì–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞</option>
                            <option value="3">–°—Ç.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞</option>
                            <option value="2">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞</option>
                            <option value="1">–ú–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞</option>
                        </select>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">–ü—Ä–∞–≤–∞</label>
                        <label for="permissionsText"></label><textarea class="form-control" name="permissions" id="permissionsText" rows="8"
                                                                       placeholder="–ó–∞–ø–æ–ª–Ω—è–π—Ç–µ –∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏..." style="white-space: pre-wrap;"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏</label>
                        <label for="responsibilitiesText"></label><textarea class="form-control" name="responsibilities" id="responsibilitiesText" rows="8"
                                                                            placeholder="–ó–∞–ø–æ–ª–Ω—è–π—Ç–µ –∫–∞–∂–¥—ã–π –ø—É–Ω–∫—Ç —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏..." style="white-space: pre-wrap;"></textarea>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary rounded-pill px-4">
                        <i class="bi bi-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </form>

            <hr class="my-4">

            <h5 class="fw-semibold mb-3">–¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:</h5>
            <div class="row row-cols-1 row-cols-md-2 g-4">
                {% for role in staff_roles %}
                <div class="col">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header bg-light">
                            <strong class="text-primary">{{ role.role_name }}</strong>
                        </div>
                        <div class="card-body">
                            <h6 class="fw-semibold text-success">–ü—Ä–∞–≤–∞:</h6>
                            <div class="bg-light p-3 rounded" style="font-size: 0.9rem;">
                                <ul>
                                    {% for item in role.permissions.split('\n') %}
                                        {% if item.strip() %}
                                            <li>{{ item }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                            <h6 class="fw-semibold text-primary mt-3">–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:</h6>
                            <div class="bg-light p-3 rounded" style="font-size: 0.9rem;">
                                <ul>
                                    {% for item in role.responsibilities.split('\n') %}
                                        {% if item.strip() %}
                                            <li>{{ item }}</li>
                                        {% endif %}
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
    .text-gradient-primary {
        background: linear-gradient(135deg, #007bff, #6610f2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .bg-purple { background-color: #9e6bff; }
    .bg-pink { background-color: #965f7f; }
    .bg-cyan { background-color: #40e0d0; }

    .card {
        border-radius: 16px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1) !important;
    }

    .staff-row {
        transition: background-color 0.2s ease;
    }

    .staff-row:hover {
        background-color: #f8f9fa !important;
    }

    .table th {
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e9ecef;
        padding: 1rem 0.5rem;
    }

    .table td {
        padding: 1rem 0.5rem;
        vertical-align: middle;
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
    }

    .btn {
        transition: all 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-1px);
    }

    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        transition: border-color 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
    }

    .modal-content {
        border-radius: 16px;
    }
</style>

<script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
    const token = localStorage.getItem("jwt");
    const CURRENT_ACCESS = parseInt(document.getElementById('userAuthData').dataset.accessLevel) || 0;
    const roleNames = {
        8: "–ö—É—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞",
        7: "–ó–∞–º.–ö—É—Ä–∞—Ç–æ—Ä–∞ –¥–∏—Å–∫–æ—Ä–¥–∞",
        6: "–ì–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞",
        5: "–°—Ç.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞",
        4: "–°–ª–µ–¥—è—â–∏–π –∑–∞ —Ö–µ–ª–ø–µ—Ä–∞–º–∏",
        3: "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞",
        2: "–ú–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞",
        1: "–•–µ–ª–ø–µ—Ä –¥–∏—Å–∫–æ—Ä–¥–∞"
    };

    function updateWarnings(memberId, type, change) {
        fetch('/update-warnings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
                id: memberId,
                type: type,
                change: change
            }),
            credentials: "include"
        })
        .then(response => {
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                if (data.dismissed) {
                    showToast(data.message, 'warning');
                }
                location.reload();
            } else {
                showToast('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏', 'error');
        });
    }

    function loadMemberData(memberId) {
        fetch(`/get-staff-member?id=${memberId}`)
            .then(r => { if (!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); return r.json(); })
            .then(data => {
                document.getElementById('memberId').value = data.id;
                document.getElementById('fullName').value = data.full_name || '';
                document.getElementById('nickname').value = data.nickname || '';
                document.getElementById('salary').value = data.salary || '';
                document.getElementById('warnings').value = data.warnings || '0/0';
                document.getElementById('vacationDate').value = data.vacation_date || '';
                document.getElementById('joinDate').value = data.join_date || '';
                document.getElementById('vkLink').value = data.vk_link || '';

                const dismissBtn = document.getElementById('dismissButton');
                if (CURRENT_ACCESS >= 6 && CURRENT_ACCESS > (data.access_level ?? 0)) {
                    dismissBtn.style.display = 'block';
                } else {
                    dismissBtn.style.display = 'none';
                }

                new bootstrap.Modal(document.getElementById('editModal')).show();
            })
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞:', err);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            });
    }

    function showDismissModal() {
        document.getElementById('dismissMemberId').value = document.getElementById('memberId').value;
        new bootstrap.Modal(document.getElementById('dismissModal')).show();
    }

    function dismissMember() {
        const formData = new FormData(document.getElementById('dismissForm'));
        const data = {
            id: formData.get('member_id'),
            reason: formData.get('dismissal_reason') || '–°–Ω—è—Ç–∏–µ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å',
            remove_roles: formData.get('remove_roles') === 'on'
        };

        fetch('/dismiss-staff-member', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify(data),
            credentials: "include"
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–Ω—è—Ç —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏', 'success');
                bootstrap.Modal.getInstance(document.getElementById('dismissModal')).hide();
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('–û—à–∏–±–∫–∞: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏', 'error');
        });
    }

    function quickDismiss(memberId) {
        if (confirm('–°–Ω—è—Ç—å —ç—Ç–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏?')) {
            fetch('/dismiss-staff-member', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    id: memberId,
                    reason: '–ë—ã—Å—Ç—Ä–æ–µ —Å–Ω—è—Ç–∏–µ',
                    remove_roles: true
                }),
                credentials: "include"
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–Ω—è—Ç —Å –¥–æ–ª–∂–Ω–æ—Å—Ç–∏', 'success');
                    document.querySelector(`tr[data-member-id="${memberId}"]`).remove();
                } else {
                    showToast('–û—à–∏–±–∫–∞: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–Ω—è—Ç–∏–∏', 'error');
            });
        }
    }

    function loadRoleData(level) {
        fetch(`/get-role-data?level=${level}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('permissionsText').value = data.permissions || '';
                document.getElementById('responsibilitiesText').value = data.responsibilities || '';
                document.getElementById('currentRoleName').textContent = roleNames[level] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ä–æ–ª—å';
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–æ–ª–∏:', error);
            });
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;
        document.body.appendChild(toast);
        new bootstrap.Toast(toast).show();
        setTimeout(() => toast.remove(), 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('dismissForm').addEventListener('submit', function(e) {
            e.preventDefault();
            dismissMember();
        });

        if (CURRENT_ACCESS >= 8) {
            const roleSelect = document.getElementById('roleSelect');
            if (roleSelect) {
                loadRoleData(roleSelect.value);
                roleSelect.addEventListener('change', function() {
                    loadRoleData(this.value);
                });
            }
        }
    });
</script>
{% endblock %}