{% extends "base.html" %}

{% block content %}
<div class="container">
    <div id="userAuthData"
         data-access-level="{{ current_user.access_level if current_user.is_authenticated else 0 }}"
         style="display: none;"></div>

    <h2 class="my-4">Состав HolyWorld</h2>

    <div class="table-responsive">
        <table class="table table-dark table-hover">
            <thead>
                <tr>
                    <th></th>
                    <th>Имя Фамилия</th>
                    <th>Ник</th>
                    <th>Должность</th>
                    <th>Discord</th>
                    <th>Зарплата</th>
                    <th>Выговоры</th>
                    <th>Отпуск</th>
                    <th>Поступил</th>
                    <th>ВКонтакте</th>
                    {% if current_user.access_level >= 4 %}<th></th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for member in staff_members %}
                <tr data-member-id="{{ member.id }}">
                    <td>
                        {% if member.avatar %}
                        <img src="{{ member.avatar }}" alt="Аватар" class="rounded-circle" width="40" height="40">
                        {% else %}
                        <i class="bi bi-person-circle" style="font-size: 1.5rem;"></i>
                        {% endif %}
                    </td>
                    <td>
                        {% if member.vk_link %}
                        <a href="{{ member.vk_link }}" target="_blank" class="text-decoration-none">
                            {{ member.full_name|default('Не указано', true) }}
                        </a>
                        {% else %}
                        {{ member.full_name|default('Не указано', true) }}
                        {% endif %}
                    </td>
                    <td>
                        {{ member.nickname|default('Не указан', true) }}
                    </td>
                    <td>
                        {% if member.access_level == 6 %}
                        <span class="badge" style="background-color: #9e6bff; color: white">Куратор дискорда</span>
                        {% elif member.access_level == 5 %}
                        <span class="badge" style="background-color: #965f7f; color: white">Зам.Куратора дискорда</span>
                        {% elif member.access_level == 4 %}
                        <span class="badge" style="background-color: #00ff22; color: darkblue">Гл.Модератор дискорда</span>
                        {% elif member.access_level == 3 %}
                        <span class="badge" style="background-color: #ff0000; color: white">Ст.Модератор дискорда</span>
                        {% elif member.access_level == 2 %}
                        <span class="badge" style="background-color: #78f4db; color: black">Модератор дискорда</span>
                        {% elif member.access_level == 1 %}
                        <span class="badge" style="background-color: #40e0d0; color: white">Мл.Модератор дискорда</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ member.username|default('Не указан', true) }}
                    </td>
                    <td>
                        {{ member.salary|default('Не указана', true) }}
                    </td>
                    <td class="warnings-cell">
                        {% set warnings = member.warnings.split('/') if member.warnings else ['0', '0'] %}
                        <div class="d-flex gap-1 align-items-center">
                            <span class="badge bg-{{ 'danger' if warnings[0]|int > 0 else 'secondary' }}">Выговор: {{ warnings[0] }}/2</span>
                            {% if current_user.access_level >= 4 %}
                                {% if warnings[0]|int > 0 %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="updateWarnings('{{ member.id }}', 'warn', -1)">-</button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-success" onclick="updateWarnings('{{ member.id }}', 'warn', 1)">+</button>
                            {% endif %}
                        </div>
                        <div class="d-flex gap-1 align-items-center mt-1">
                            <span class="badge bg-{{ 'warning' if warnings[1]|int > 0 else 'secondary' }}">Предупреждение: {{ warnings[1] }}/3</span>
                            {% if current_user.access_level >= 4 %}
                                {% if warnings[1]|int > 0 %}
                                    <button class="btn btn-sm btn-outline-danger" onclick="updateWarnings('{{ member.id }}', 'pred', -1)">-</button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-success" onclick="updateWarnings('{{ member.id }}', 'pred', 1)">+</button>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {{ member.vacation_date.strftime('%d.%m.%Y') if member.vacation_date else 'Не в отпуске' }}
                    </td>
                    <td>
                        {{ member.join_date.strftime('%d.%m.%Y') if member.join_date else '-' }}
                    </td>
                    <td>
                        {% if member.vk_link %}
                        <a href="{{ member.vk_link }}" target="_blank" class="text-decoration-none">
                            <i class="bi bi-link-45deg"></i> Профиль
                        </a>
                        {% else %}
                        Не указан
                        {% endif %}
                    </td>
                    {% if current_user.access_level >= 4 %}
                    <td>
                        <button class="btn btn-sm btn-outline-primary"
                                onclick="loadMemberData('{{ member.id }}')">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title">Редактирование сотрудника</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editForm" method="POST" action="{{ url_for('update_staff_member') }}">
                    <input type="hidden" name="member_id" id="memberId">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Имя Фамилия</label>
                                <label for="fullName"></label><input type="text" class="form-control" name="full_name" id="fullName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Ник</label>
                                <label for="nickname"></label><input type="text" class="form-control" name="nickname" id="nickname">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Зарплата</label>
                                <label for="salary"></label><input type="text" class="form-control" name="salary" id="salary">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Выговор/Предупреждение</label>
                                <label for="warnings"></label><input type="text" class="form-control" name="warnings" id="warnings" placeholder="0/0">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Дата отпуска</label>
                                <label for="vacationDate"></label><input type="date" class="form-control" name="vacation_date" id="vacationDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Дата поступления на должность</label>
                                <label for="joinDate"></label><input type="date" class="form-control" name="join_date" id="joinDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ВКонтакте</label>
                                <label for="vkLink"></label><input type="url" class="form-control" name="vk_link" id="vkLink" placeholder="https://vk.com/username">
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                        <button type="submit" class="btn btn-primary">Сохранить</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const CURRENT_ACCESS = parseInt(document.getElementById('userAuthData').dataset.accessLevel) || 0;

        function updateWarnings(memberId, type, change) {
            fetch('/update-warnings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': '123'
                },
                body: JSON.stringify({
                    id: memberId,
                    type: type,
                    change: change
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Ошибка сети');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Ошибка при обновлении: ' + error.message);
            });
        }

        function loadMemberData(memberId) {
            fetch(`/get-staff-member?id=${memberId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Ошибка сети');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('memberId').value = data.id;
                    document.getElementById('fullName').value = data.full_name || '';
                    document.getElementById('nickname').value = data.nickname || '';
                    document.getElementById('salary').value = data.salary || '';
                    document.getElementById('warnings').value = data.warnings || '0/0';
                    document.getElementById('vacationDate').value = data.vacation_date || '';
                    document.getElementById('joinDate').value = data.join_date || '';
                    document.getElementById('vkLink').value = data.vk_link || '';

                    const modal = new bootstrap.Modal(document.getElementById('editModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка загрузки данных: ' + error.message);
                });
        }

        if (CURRENT_ACCESS >= 6 && document.getElementById('roleSelect')) {
            const roleSelect = document.getElementById('roleSelect');

            roleSelect.addEventListener('change', function() {
                fetch(`/get-role-data?level=${this.value}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('permissionsText').value = data.permissions || '';
                        document.getElementById('responsibilitiesText').value = data.responsibilities || '';
                    });
            });

            fetch(`/get-role-data?level=${roleSelect.value}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('permissionsText').value = data.permissions || '';
                    document.getElementById('responsibilitiesText').value = data.responsibilities || '';
                });
        }
    </script>

    {% if current_user.access_level >= 6 %}
    <div class="card border-primary mt-5">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">Управление правами и обязанностями</h4>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('update_staff_roles') }}">
                <div class="mb-3">
                    <label class="form-label">Должность</label>
                    <label for="roleSelect"></label><select class="form-select" name="role_level" id="roleSelect">
                        <option value="6">Куратор дискорда</option>
                        <option value="5">Зам.Куратора дискорда</option>
                        <option value="4">Гл.Модератор дискорда</option>
                        <option value="3">Ст.Модератор дискорда</option>
                        <option value="2">Модератор дискорда</option>
                        <option value="1">Мл.Модератор дискорда</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Права</label>
                    <label for="permissionsText"></label><textarea class="form-control" name="permissions" id="permissionsText" rows="6"
                                                                   placeholder="Вводите каждый пункт с новой строки" style="white-space: pre-wrap;"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Обязанности</label>
                    <label for="responsibilitiesText"></label><textarea class="form-control" name="responsibilities" id="responsibilitiesText" rows="6"
                                                                        placeholder="Вводите каждый пункт с новой строки" style="white-space: pre-wrap;"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">Сохранить</button>
            </form>

            <hr class="my-4">

            <h5>Текущие права и обязанности:</h5>
            <div class="row mt-3">
                {% for role in staff_roles %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <strong>{{ role.role_name }}</strong>
                        </div>
                        <div class="card-body">
                            <h6>Права:</h6>
                            <div style="white-space: pre-wrap;">{{ role.permissions }}</div>
                            <hr>
                            <h6>Обязанности:</h6>
                            <div style="white-space: pre-wrap;">{{ role.responsibilities }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}