{% extends "base.html" %}

{% block content %}
<div class="container">
    <div id="userAuthData"
         data-access-level="{{ current_user.access_level if current_user.is_authenticated else 0 }}"
         style="display: none;"></div>

    <h2 class="my-4">–†–∞—Å—á—ë—Ç –ó–ü</h2>

    {% if current_user.access_level >= 5 %}
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h4><i class="bi bi-clipboard-data me-2"></i>–í–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h4>
        </div>
        <div class="card-body">
            <form id="statsForm" method="POST" action="{{ url_for('update_moderator_stats') }}">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</label>
                        <label for="userSelect"></label><select class="form-select" name="user_id" id="userSelect" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞</option>
                            {% for member in staff_members %}
                            {% if member.access_level >= 1%}
                            <option value="{{ member.id }}">{{ member.username }}</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">–û–±—â–µ–µ –ù–ö</label>
                        <label>
                            <input type="number" class="form-control" name="punishments" min="0" required>
                        </label>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">–¢–∏–∫–µ—Ç–æ–≤</label>
                        <label>
                            <input type="number" class="form-control" name="tickets_closed" min="0" required>
                        </label>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ –Ω–µ–¥–µ–ª—å</label>
                        <label>
                            <input type="number" class="form-control" name="weeks_missed" min="0" required>
                        </label>
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">üíæ</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">–†–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã –∑–∞ {{ current_month }}/{{ current_year }}</h4>
            <div>
                {% if current_user.access_level >= 5 %}
                <button class="btn btn-success me-2" onclick="calculateSalaries()">
                    <i class="bi bi-calculator me-1"></i>–†–∞—Å—Å—á–∏—Ç–∞—Ç—å
                </button>
                <button class="btn btn-warning" onclick="payoutSalaries()">
                    <i class="bi bi-cash-coin me-1"></i>–í—ã–¥–∞—Ç—å
                </button>
                {% endif %}
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</th>
                            <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                            <th>–û–±—â–µ–µ –ù–ö</th>
                            <th>–°–∫–æ—Ä—Ä. –ù–ö</th>
                            <th>–¢–∏–∫–µ—Ç—ã</th>
                            <th>–¢–æ–ø –ø–æ –ù–ö</th>
                            <th>–ü—Ä–æ–ø—É—â–µ–Ω–æ –Ω–µ–¥–µ–ª—å</th>
                            <th>% –ó–∞ —Ç–∏–∫–µ—Ç—ã</th>
                            <th>% –ó–∞ –¥–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                            <th>% –ó–∞ –¢–æ–ø –º–æ–¥–µ—Ä–∞</th>
                            <th>% –ó–∞ —Ç–æ–ø</th>
                            <th>–ó–ü –∑–∞ –ù–ö</th>
                            <th>–û–±—â–∏–π %</th>
                            <th>–ò—Ç–æ–≥–æ–≤–∞—è –ó–ü</th>
                            {% if current_user.access_level >= 5 %}
                            <th></th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in current_stats %}
                        {% set calc = calculated_data[stat.user_id] %}
                        <tr>
                            <td class="text-center">
                                {{ stat.user.nickname }}
                            </td>
                            <td>
                                {% if stat.user.access_level == 6 %}
                                    <span class="badge"
                                          style="background-color: #9e6bff; color: white">–ö—É—Ä–∞—Ç–æ—Ä</span>
                                {% elif stat.user.access_level == 5 %}
                                    <span class="badge" style="background-color: #965f7f; color: white">–ó–∞–º.–ö—É—Ä–∞—Ç–æ—Ä–∞</span>
                                {% elif stat.user.access_level == 4 %}
                                    <span class="badge" style="background-color: #00ff22; color: darkblue">–ì–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                {% elif stat.user.access_level == 3 %}
                                    <span class="badge" style="background-color: #ff0000; color: white">–°—Ç.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                {% elif stat.user.access_level == 2 %}
                                    <span class="badge" style="background-color: #78f4db; color: black">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                {% elif stat.user.access_level == 1 %}
                                    <span class="badge" style="background-color: #40e0d0; color: white">–ú–ª.–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                {% endif %}
                            </td>
                            <td class="text-center">{{ stat.punishments }}</td>
                            <td class="text-center">{{ calc.adjusted_punishments if calc.adjusted_punishments else stat.punishments }}</td>
                            <td class="text-center">{{ stat.tickets_closed }}</td>
                            <td class="text-center">{{ calc.rank if calc.rank > 0 else '-' }}</td>
                            <td class="text-center">{{ stat.weeks_missed if stat.weeks_missed > 0 else '-' }}</td>
                            <td class="text-center">{{ calc.ticket_display }}</td>
                            <td class="text-center">{{ calc.position_display }}</td>
                            <td class="text-center">{{ calc.top_mod_display }}</td>
                            <td class="text-center">{{ calc.rank_display }}</td>
                            <td class="text-center">{{ calc.base_salary }}</td>
                            <td class="text-center">{{ calc.total_display }}</td>
                            <td class="text-center fw-bold">{{ calc.final_salary }}</td>
                            {% if current_user.access_level >= 5 %}
                            <td class="text-center">
                                <button class="btn btn-sm btn-outline-warning"
                                        onclick="editStats({{ stat.user_id }})"
                                        title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <i class="bi bi-pencil"></i>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs mt-4" id="salaryTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#current">–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history">–ò—Å—Ç–æ—Ä–∏—è –∑–∞—Ä–ø–ª–∞—Ç</button>
        </li>
    </ul>

    <div class="tab-content mt-2">
        <div class="tab-pane fade show active" id="current">
        </div>

        <div class="tab-pane fade" id="history">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="historyMonth"></label><select class="form-select" id="historyMonth">
                                <option value="">–í—Å–µ –º–µ—Å—è—Ü—ã</option>
                                {% for i in range(1, 13) %}
                                <option value="{{ i }}">{{ i }} –º–µ—Å—è—Ü</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="historyYear"></label><select class="form-select" id="historyYear">
                                <option value="">–í—Å–µ –≥–æ–¥—ã</option>
                                {% for year in available_years %}
                                <option value="{{ year }}">{{ year }} –≥–æ–¥</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100" onclick="loadSalaryHistory()">
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å
                            </button>
                        </div>
                    </div>

                    <div id="historyContent" class="table-responsive">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const CURRENT_ACCESS = parseInt(document.getElementById('userAuthData').dataset.accessLevel) || 0;

    function editStats(userId) {
        fetch(`/get-mod-stats?user_id=${userId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('userSelect').value = data.user_id;
                document.querySelector('[name="punishments"]').value = data.punishments;
                document.querySelector('[name="tickets_closed"]').value = data.tickets_closed;
                document.querySelector('[name="weeks_missed"]').value = data.weeks_missed;

                document.getElementById('statsForm').scrollIntoView({
                    behavior: 'smooth'
                });
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
    }

    function calculateSalaries() {
        if (!confirm('–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—ã –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü?')) return;

        fetch('/calculate-salaries', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-KEY': '123'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ó–∞—Ä–ø–ª–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –∑–∞—Ä–ø–ª–∞—Ç');
        });
    }

    function payoutSalaries() {
        if (!confirm('–í—ã–¥–∞—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—ã –≤—Å–µ–º –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü?')) return;

        fetch('/payout-salaries', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-API-KEY': '123'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('–ó–∞—Ä–ø–ª–∞—Ç—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω—ã!');
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ –∑–∞—Ä–ø–ª–∞—Ç');
        });
    }

    function loadSalaryHistory() {
        const month = document.getElementById('historyMonth').value;
        const year = document.getElementById('historyYear').value;

        fetch(`/salary-history?month=${month}&year=${year}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('historyContent').innerHTML = data.html;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏');
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const triggerTabList = document.querySelectorAll('#salaryTabs button');
        triggerTabList.forEach(triggerEl => {
            new bootstrap.Tab(triggerEl);
        });
    });
</script>

<style>
    .table th {
        font-size: 0.85rem;
        vertical-align: middle;
    }
    .table td {
        font-size: 0.9rem;
        vertical-align: middle;
    }
    .btn-sm {
        padding: 0.15rem 0.5rem;
        font-size: 0.75rem;
    }
</style>
{% endblock %}