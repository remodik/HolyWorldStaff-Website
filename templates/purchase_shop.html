{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 fw-bold text-gradient-primary">üõçÔ∏è HolyStaff Shop</h2>
        <button class="btn btn-success btn-lg rounded-pill shadow-sm" type="button" data-bs-toggle="modal" data-bs-target="#purchaseModal">
            <i class="bi bi-cart-plus me-2"></i>–ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É
        </button>
    </div>

    <div class="card border-0 shadow-sm mb-4 glass-card">
        <div class="card-header bg-transparent border-0 py-3">
            <h5 class="mb-0 text-primary fw-semibold">üìã –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–∫—É–ø–æ–∫</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-success bg-opacity-10 border-success mb-3">
                        <div class="card-body">
                            <h6 class="card-title text-success fw-semibold">‚úÖ –ß—Ç–æ –ú–û–ñ–ù–û –ø–æ–∫—É–ø–∞—Ç—å:</h6>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">‚Ä¢ –ü–æ–∫—É–ø–∞—Ç—å –∫–æ–º—É —É–≥–æ–¥–Ω–æ –ª—é–±—ã–µ –≤–µ—â–∏ –≤ —Å–∞–π—Ç–µ</li>
                                <li>‚Ä¢ –ü–æ–∫—É–ø–∞—Ç—å –¥–æ–∫—É–ø –¥–æ–Ω–∞—Ç–∞ (+20% –∫ —Ü–µ–Ω–µ)</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-danger bg-opacity-10 border-danger">
                        <div class="card-body">
                            <h6 class="card-title text-danger fw-semibold">‚ùå –ß—Ç–æ –ù–ï–õ–¨–ó–Ø –ø–æ–∫—É–ø–∞—Ç—å:</h6>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-1">‚Ä¢ –†–∞–∑–±–∞–Ω/—Ä–∞–∑–º—É—Ç</li>
                                <li class="mb-1">‚Ä¢ –ö–æ–∏–Ω—ã –Ω–∞ –ª–∞–π—Ç</li>
                                <li class="mb-1">‚Ä¢ –ü–æ–∫—É–ø–Ω–æ–≥–æ —Å—Ç–∞–∂–µ—Ä–∞</li>
                                <li>‚Ä¢ –ö–∞—Å—Ç–æ–º–Ω—ã–π –¥–æ–Ω–∞—Ç —á–∞—â–µ —Ä–∞–∑–∞ –≤ –≥–æ–¥</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="purchaseModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-gradient-success text-white">
                    <h5 class="modal-title fw-semibold">üìù –ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('submit_purchase_request') }}" id="purchaseForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">–†–µ–∂–∏–º</label>
                            <label>
                                <select class="form-select form-select-lg" name="mode" required>
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º</option>
                                    <option value="Lite">Lite</option>
                                    <option value="–ö–ª–∞—Å—Å–∏–∫">–ö–ª–∞—Å—Å–∏–∫</option>
                                </select>
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">–ò–≥—Ä–æ–≤–æ–π –Ω–∏–∫</label>
                            <label>
                                <input type="text" class="form-control form-control-lg" name="nickname" required
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫">
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">–ß—Ç–æ –ø–æ–∫—É–ø–∞–µ—Ç–µ</label>
                            <label><textarea class="form-control" name="item" rows="3" required
                                             placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ –ø–æ–∫—É–ø–∫—É"></textarea>
                            </label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-semibold">–°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏</label>
                            <label>
                                <input type="number" class="form-control form-control-lg" name="amount" required
                                       min="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É">
                            </label>
                            <div class="form-text">
                                –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <strong class="text-primary">{{ current_user.salary or '0' }}</strong>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary rounded-pill" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" form="purchaseForm" class="btn btn-primary rounded-pill px-4">
                        üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if current_user.access_level >= 8 and pending_requests %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-warning bg-opacity-25 border-0 py-3">
            <h5 class="mb-0 fw-semibold">‚è≥ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</h5>
        </div>
        <div class="card-body">
            {% for request in pending_requests %}
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h6 class="text-primary fw-semibold">–ó–∞—è–≤–∫–∞ #{{ request.id }}</h6>
                        <span class="badge bg-warning rounded-pill">–û–∂–∏–¥–∞–µ—Ç</span>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>–û—Ç:</strong> {{ request.user.username }}</p>
                            <p class="mb-1"><strong>–†–µ–∂–∏–º:</strong> {{ request.mode }}</p>
                            <p class="mb-1"><strong>–ù–∏–∫:</strong> {{ request.nickname }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>–°—É–º–º–∞:</strong> {{ request.amount }}</p>
                            <p class="mb-1"><strong>–ë–∞–ª–∞–Ω—Å:</strong> {{ request.user.salary or '0' }}</p>
                        </div>
                    </div>

                    <p class="mb-3"><strong>–ü–æ–∫—É–ø–∫–∞:</strong> {{ request.item }}</p>

                    <form method="POST" action="{{ url_for('process_purchase_request', request_id=request.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:</label>
                            <label><textarea class="form-control" name="rejection_reason" rows="2"
                                             placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞..."></textarea>
                            </label>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" name="action" value="approve"
                                    class="btn btn-success rounded-pill flex-fill">
                                ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
                            </button>
                            <button type="submit" name="action" value="reject"
                                    class="btn btn-outline-danger rounded-pill flex-fill">
                                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-info bg-opacity-25 border-0 py-3">
            <h5 class="mb-0 fw-semibold">üìä –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-semibold">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
                <label for="statusFilter"></label><select class="form-select" id="statusFilter" onchange="filterRequests()">
                    <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                    <option value="approved">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
                    <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>

            <div id="requestsList">
                {% for request in user_requests %}
                <div class="card border-0 shadow-sm mb-3 request-item" data-status="{{ request.status }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="text-primary fw-semibold">–ó–∞—è–≤–∫–∞ #{{ request.id }}</h6>
                            {% if request.status == 'pending' %}
                                <span class="badge bg-warning rounded-pill">‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
                            {% elif request.status == 'approved' %}
                                <span class="badge bg-success rounded-pill">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</span>
                            {% else %}
                                <span class="badge bg-danger rounded-pill">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                            {% endif %}
                        </div>

                        <div class="row mb-2">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>–†–µ–∂–∏–º:</strong> {{ request.mode }}</p>
                                <p class="mb-1"><strong>–ù–∏–∫:</strong> {{ request.nickname }}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>–°—É–º–º–∞:</strong> {{ request.amount }}</p>
                                <p class="mb-1"><strong>–î–∞—Ç–∞:</strong> {{ request.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                            </div>
                        </div>

                        <p class="mb-2"><strong>–ü–æ–∫—É–ø–∫–∞:</strong> {{ request.item }}</p>

                        {% if request.status == 'rejected' and request.rejection_reason %}
                        <div class="alert alert-danger mt-2 mb-0 py-2">
                            <strong>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:</strong> {{ request.rejection_reason }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-4 text-muted"></i>
                    <p class="text-muted mt-2">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ–∫—É–ø–∫–∏</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
    .text-gradient-primary {
        background: linear-gradient(135deg, #007bff, #6610f2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .bg-gradient-success {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .glass-card {
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
    }

    .card {
        border-radius: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1) !important;
    }

    .btn {
        transition: all 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-1px);
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: border-color 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
    }
</style>

<script>
    function filterRequests() {
        const status = document.getElementById('statusFilter').value;
        const requestItems = document.querySelectorAll('.request-item');

        requestItems.forEach(item => {
            if (status === 'all' || item.getAttribute('data-status') === status) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        const purchaseModal = document.getElementById('purchaseModal');
        purchaseModal.addEventListener('hidden.bs.modal', function () {
            document.getElementById('purchaseForm').reset();
        });

        filterRequests();
    });
</script>
{% endblock %}