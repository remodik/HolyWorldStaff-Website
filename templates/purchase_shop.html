{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>HolyStaff Shop</h2>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5>üìã –ü—Ä–∞–≤–∏–ª–∞ –ø–æ–∫—É–ø–æ–∫</h5>
        </div>
        <div class="card-body">
            <h6>‚úÖ –ß—Ç–æ –ú–û–ñ–ù–û –ø–æ–∫—É–ø–∞—Ç—å:</h6>
            <ul>
                <li>–ü–æ–∫—É–ø–∞—Ç—å –∫–æ–º—É —É–≥–æ–¥–Ω–æ –ª—é–±—ã–µ –≤–µ—â–∏ –≤ —Å–∞–π—Ç–µ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —É—Å–ª—É–≥–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–æ–Ω–∞—Ç–∞</li>
                <li>–ü–æ–∫—É–ø–∞—Ç—å –¥–æ–∫—É–ø –¥–æ–Ω–∞—Ç–∞, –Ω–æ –∫ —Ü–µ–Ω–µ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å +20% —Ü–µ–Ω—ã</li>
            </ul>

            <h6>‚ùå –ß—Ç–æ –ù–ï–õ–¨–ó–Ø –ø–æ–∫—É–ø–∞—Ç—å:</h6>
            <ul>
                <li>–†–∞–∑–±–∞–Ω</li>
                <li>–†–∞–∑–º—É—Ç</li>
                <li>–ö–æ–∏–Ω—ã –Ω–∞ –ª–∞–π—Ç</li>
                <li>–ü–æ–∫—É–ø–Ω–æ–≥–æ —Å—Ç–∞–∂–µ—Ä–∞</li>
                <li>–ö–∞—Å—Ç–æ–º–Ω—ã–π –¥–æ–Ω–∞—Ç —á–∞—â–µ —á–µ–º —Ä–∞–∑ –≤ –≥–æ–¥</li>
            </ul>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">üìù –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–∫—É–ø–∫—É</h5>
            <button class="btn btn-light btn-sm" type="button" data-bs-toggle="collapse"
                    data-bs-target="#purchaseForm" aria-expanded="false"
                    aria-controls="purchaseForm">
                –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É
            </button>
        </div>

        <div class="collapse" id="purchaseForm">
            <div class="card-body">
                <form method="POST" action="{{ url_for('submit_purchase_request') }}">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–†–µ–∂–∏–º</label>
                            <label>
                                <input type="text" class="form-control" name="mode" required
                                       placeholder="Lite / –ö–ª–∞—Å—Å–∏–∫">
                            </label>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">–ò–≥—Ä–æ–≤–æ–π –Ω–∏–∫:</label>
                            <label>
                                <input type="text" class="form-control" name="nickname" required
                                       placeholder="–í–∞—à –Ω–∏–∫ –≤ –∏–≥—Ä–µ">
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–ß—Ç–æ –ø–æ–∫—É–ø–∞–µ—Ç–µ:</label>
                        <label>
<textarea class="form-control" name="item" rows="3" required
          placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å"></textarea>
                        </label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">–°—É–º–º–∞ –ø–æ–∫—É–ø–∫–∏:</label>
                        <div class="input-group">
                            <span class="input-group-text"></span>
                            <label>
                                <input type="number" class="form-control" name="amount" required
                                       min="1" placeholder="–¢–æ—á–Ω–æ–µ —á–∏—Å–ª–æ">
                            </label>
                        </div>
                        <small class="form-text text-muted">
                            –í–∞—à —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <strong>{{ current_user.salary or '0' }}</strong>
                        </small>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ
                    </button>
                </form>
            </div>
        </div>
    </div>

    {% if current_user.access_level >= 6 and pending_requests %}
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <h5>‚è≥ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</h5>
        </div>
        <div class="card-body">
            {% for request in pending_requests %}
            <div class="card mb-3">
                <div class="card-body">
                    <h6>–ó–∞—è–≤–∫–∞ #{{ request.id }}</h6>
                    <p><strong>–û—Ç:</strong> {{ request.user.username }}</p>
                    <p><strong>–†–µ–∂–∏–º:</strong> {{ request.mode }}</p>
                    <p><strong>–ù–∏–∫:</strong> {{ request.nickname }}</p>
                    <p><strong>–ü–æ–∫—É–ø–∫–∞:</strong> {{ request.item }}</p>
                    <p><strong>–°—É–º–º–∞:</strong> {{ request.amount }}</p>
                    <p><strong>–ï–≥–æ –±–∞–ª–∞–Ω—Å:</strong> {{ request.user.salary or '0' }}</p>

                    <form method="POST" action="{{ url_for('process_purchase_request', request_id=request.id) }}">
                        <div class="mb-2">
                            <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ (–µ—Å–ª–∏ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç–µ):</label>
                            <label>
<textarea class="form-control" name="rejection_reason" rows="2"
          placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞..."></textarea>
                            </label>
                        </div>

                        <div class="btn-group">
                            <button type="submit" name="action" value="approve"
                                    class="btn btn-success">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
                            <button type="submit" name="action" value="reject"
                                    class="btn btn-danger">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header bg-info text-white">
            <h5>üìä –ò—Å—Ç–æ—Ä–∏—è –≤–∞—à–∏—Ö –∑–∞—è–≤–æ–∫</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="statusFilter"></label><select class="form-select" id="statusFilter" onchange="filterRequests()">
                    <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="pending">–ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</option>
                    <option value="approved">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
                    <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</option>
                </select>
            </div>

            <div id="requestsList">
                {% for request in user_requests %}
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>–ó–∞—è–≤–∫–∞ #{{ request.id }}</h6>
                                <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
                                    {% if request.status == 'pending' %}
                                        <span class="badge bg-warning">‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>
                                    {% elif request.status == 'approved' %}
                                        <span class="badge bg-success">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</span>
                                    {% else %}
                                        <span class="badge bg-danger">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>
                                    {% endif %}
                                </p>
                                <p><strong>–†–µ–∂–∏–º:</strong> {{ request.mode }}</p>
                                <p><strong>–ù–∏–∫:</strong> {{ request.nickname }}</p>
                                <p><strong>–ü–æ–∫—É–ø–∫–∞:</strong> {{ request.item }}</p>
                                <p><strong>–°—É–º–º–∞:</strong> {{ request.amount }}</p>
                                <p><strong>–î–∞—Ç–∞:</strong> {{ request.created_at.strftime('%d.%m.%Y %H:%M') }}</p>

                                {% if request.status == 'rejected' and request.rejection_reason %}
                                <p><strong>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:</strong>
                                    <span class="text-danger">{{ request.rejection_reason }}</span>
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –ø–æ–∫—É–ø–∫–∏.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function filterRequests() {
    const status = document.getElementById('statusFilter').value;

    fetch(`/get-purchase-requests?status=${status}`)
        .then(response => response.json())
        .then(data => {
            const requestsList = document.getElementById('requestsList');
            requestsList.innerHTML = '';

            if (data.requests.length === 0) {
                requestsList.innerHTML = '<p class="text-muted">–ó–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
                return;
            }

            data.requests.forEach(request => {
                let statusBadge;
                if (request.status === 'pending') {
                    statusBadge = '<span class="badge bg-warning">‚è≥ –ù–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</span>';
                } else if (request.status === 'approved') {
                    statusBadge = '<span class="badge bg-success">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</span>';
                } else {
                    statusBadge = '<span class="badge bg-danger">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</span>';
                }

                let rejectionReason = '';
                if (request.status === 'rejected' && request.rejection_reason) {
                    rejectionReason = `<p><strong>–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:</strong>
                        <span class="text-danger">${request.rejection_reason}</span></p>`;
                }

                requestsList.innerHTML += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6>–ó–∞—è–≤–∫–∞ #${request.id}</h6>
                                    <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${statusBadge}</p>
                                    <p><strong>–†–µ–∂–∏–º:</strong> ${request.mode}</p>
                                    <p><strong>–ù–∏–∫:</strong> ${request.nickname}</p>
                                    <p><strong>–ü–æ–∫—É–ø–∫–∞:</strong> ${request.item}</p>
                                    <p><strong>–°—É–º–º–∞:</strong> ${request.amount}</p>
                                    <p><strong>–î–∞—Ç–∞:</strong> ${request.created_at}</p>
                                    ${rejectionReason}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        });
}
</script>
{% endblock %}